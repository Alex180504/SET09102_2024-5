<?xml version="1.0" encoding="utf-8" ?>
<views:ViewBase xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:vm="clr-namespace:SET09102_2024_5.ViewModels"
                xmlns:models="clr-namespace:SET09102_2024_5.Models"
                xmlns:converters="clr-namespace:SET09102_2024_5.Converters"
                xmlns:helpers="clr-namespace:SET09102_2024_5.Helpers"
                xmlns:controls="clr-namespace:SET09102_2024_5.Views.Controls"
                xmlns:views="clr-namespace:SET09102_2024_5.Views"
                xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
                x:DataType="vm:RoleManagementViewModel"
                x:Class="SET09102_2024_5.Views.RoleManagementPage"
                Title="Role Management"
                BackgroundColor="{AppThemeBinding Light=#f8f9fa, Dark=#121212}">

  <ContentPage.Resources>
    <ResourceDictionary>
      <!-- Enhanced Card Style with deeper shadows and better elevation -->
      <Style x:Key="ModernCardStyle"
          TargetType="Frame">
        <Setter Property="BorderColor"
            Value="{AppThemeBinding Light=#e0e0e0, Dark=#3e3e3e}"/>
        <Setter Property="BackgroundColor"
            Value="{AppThemeBinding Light=White, Dark=#2d2d2d}"/>
        <Setter Property="CornerRadius"
            Value="16"/>
        <Setter Property="HasShadow"
            Value="True"/>
        <Setter Property="Padding"
            Value="0"/>
        <Setter Property="Margin"
            Value="0,8"/>
        <Setter Property="Shadow">
          <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=#40000000}"
                  Offset="0,4"
                  Radius="12"/>
        </Setter>
      </Style>

      <!-- Modern button style -->
      <Style x:Key="ModernActionButton"
          TargetType="Button">
        <Setter Property="CornerRadius"
            Value="8"/>
        <Setter Property="Padding"
            Value="20,12"/>
        <Setter Property="TextColor"
            Value="White"/>
        <Setter Property="FontAttributes"
            Value="Bold"/>
        <Setter Property="FontSize"
            Value="14"/>
        <Setter Property="Shadow">
          <Shadow Brush="#40000000"
              Offset="0,3"
              Radius="6"/>
        </Setter>
      </Style>

      <!-- Modern outlined button style -->
      <Style x:Key="OutlinedButton"
          TargetType="Button">
        <Setter Property="BorderWidth"
            Value="1"/>
        <Setter Property="CornerRadius"
            Value="8"/>
        <Setter Property="Padding"
            Value="20,12"/>
        <Setter Property="BackgroundColor"
            Value="Transparent"/>
        <Setter Property="FontAttributes"
            Value="Bold"/>
        <Setter Property="FontSize"
            Value="14"/>
      </Style>
      
      <converters:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter"/>
      <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
      <converters:NullToBoolConverter x:Key="NullToBoolConverter"/>
    </ResourceDictionary>
  </ContentPage.Resources>

  <Grid>
    <ScrollView>
      <VerticalStackLayout Padding="20"
          Spacing="20">
        <!-- Page Header -->
        <Border StrokeThickness="0"
            StrokeShape="RoundRectangle 16">
          <Border.Background>
            <LinearGradientBrush StartPoint="0,0"
                EndPoint="1,1">
              <GradientStop Color="{AppThemeBinding Light=#3f51b5,Dark=#303f9f}"
                  Offset="0"/>
              <GradientStop Color="{AppThemeBinding Light=#5c6bc0,Dark=#3949ab}"
                  Offset="1"/>
            </LinearGradientBrush>
          </Border.Background>
          <Grid Padding="24"
              ColumnDefinitions="Auto,*,Auto">
            <Label Text="{x:Static helpers:MaterialIcons.Group}"
                FontFamily="MaterialIcons"
                TextColor="White"
                FontSize="36"
                VerticalOptions="Center"/>
            <VerticalStackLayout Grid.Column="1"
                Margin="16,0,0,0">
              <Label Text="Role Management"
                  FontSize="28"
                  FontAttributes="Bold"
                  TextColor="White"/>
              <Label Text="Create and manage roles with specific access privileges"
                  FontSize="16"
                  TextColor="#e0e0e0"/>
            </VerticalStackLayout>
            <Button Grid.Column="2"
                Text="{x:Static helpers:MaterialIcons.Refresh}"
                FontFamily="MaterialIcons"
                Command="{Binding InitializeDataCommand}"
                BackgroundColor="#ffffff30"
                TextColor="White"
                FontSize="20"
                Padding="12"
                CornerRadius="12"/>
          </Grid>
        </Border>

        <!-- Using normal tabs instead of Community Toolkit TabView due to reference issues -->
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
          </Grid.RowDefinitions>

          <!-- Tab Headers -->
          <HorizontalStackLayout Grid.Row="0"
              Spacing="0">
            <Button Text="Create Role"
                    BackgroundColor="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                    TextColor="White"
                    Command="{Binding SwitchTabCommand}"
                    CommandParameter="create"
                    Padding="20,12"
                    Margin="0,0,1,0"
                    CornerRadius="8"
                    BorderWidth="0"
                    IsVisible="{Binding IsManageRolesTab}"/>

            <Button Text="Create Role"
                    BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                    TextColor="{AppThemeBinding Light=#1976D2, Dark=White}"
                    BorderWidth="0"
                    Padding="20,12"
                    Margin="0,0,1,0"
                    CornerRadius="8"
                    IsVisible="{Binding IsCreateRoleTab}"/>

            <Button Text="Manage Roles"
                    BackgroundColor="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                    TextColor="White"
                    Command="{Binding SwitchTabCommand}"
                    CommandParameter="manage"
                    Padding="20,12"
                    CornerRadius="8"
                    BorderWidth="0"
                    IsVisible="{Binding IsCreateRoleTab}"/>

            <Button Text="Manage Roles"
                    BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                    TextColor="{AppThemeBinding Light=#1976D2, Dark=White}"
                    BorderWidth="0"
                    Padding="20,12"
                    CornerRadius="8"
                    IsVisible="{Binding IsManageRolesTab}"/>
          </HorizontalStackLayout>

          <!-- Tab Content -->
          <Grid Grid.Row="1">
            <!-- Create Role Tab -->
            <ScrollView IsVisible="{Binding IsCreateRoleTab}">
              <Frame Style="{StaticResource ModernCardStyle}">
                <!-- Create New Role section copied from original implementation -->
                <Grid RowDefinitions="Auto,*,Auto">
                  <!-- Card Header with gradient -->
                  <Border Grid.Row="0"
                         StrokeThickness="0"
                         StrokeShape="RoundRectangle 16,16,0,0">
                    <Border.Background>
                      <LinearGradientBrush StartPoint="0,0"
                          EndPoint="1,1">
                        <GradientStop Color="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                            Offset="0.0"/>
                        <GradientStop Color="{AppThemeBinding Light=#42a5f5, Dark=#1e88e5}"
                            Offset="1.0"/>
                      </LinearGradientBrush>
                    </Border.Background>

                    <Grid Padding="20,16">
                      <HorizontalStackLayout Spacing="12">
                        <Label Text="{x:Static helpers:MaterialIcons.Add_Circle}"
                               FontFamily="MaterialIcons"
                               TextColor="White"
                               FontSize="24"
                               VerticalOptions="Center"/>
                        <Label Text="Create New Role"
                               FontAttributes="Bold"
                               FontSize="20"
                               TextColor="White"
                               VerticalOptions="Center"/>
                      </HorizontalStackLayout>
                    </Grid>
                  </Border>

                  <!-- Card Content with improved inputs -->
                  <ScrollView Grid.Row="1">
                    <VerticalStackLayout Padding="24,20" Spacing="16">
                      <!-- Role form content here -->
                      <Label Text="Role Information" 
                            FontAttributes="Bold" 
                            FontSize="16" 
                            TextColor="{AppThemeBinding Light=#212121, Dark=#e0e0e0}"
                            Margin="0,0,0,10"/>
                      
                      <Label Text="Role Name"
                             FontSize="14"
                             TextColor="{AppThemeBinding Light=#505050, Dark=#b0b0b0}"/>

                      <Border Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                              StrokeThickness="1"
                              StrokeShape="RoundRectangle 10"
                              BackgroundColor="{AppThemeBinding Light=#f7f7f7, Dark=#333333}"
                              Padding="5,0"
                              Margin="0,4,0,8">
                        <Entry Placeholder="Enter role name"
                               Text="{Binding NewRoleName}"
                               BackgroundColor="Transparent"
                               Margin="10,0"/>
                      </Border>

                      <Label Text="Description"
                             FontSize="14"
                             TextColor="{AppThemeBinding Light=#505050, Dark=#b0b0b0}"/>

                      <Border Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                              StrokeThickness="1"
                              StrokeShape="RoundRectangle 10"
                              BackgroundColor="{AppThemeBinding Light=#f7f7f7, Dark=#333333}"
                              Padding="5,0"
                              Margin="0,4,0,16">
                        <Entry Placeholder="Enter role description"
                               Text="{Binding NewRoleDescription}"
                               BackgroundColor="Transparent"
                               Margin="10,0"/>
                      </Border>

                      <Label Text="Role Privileges" 
                            FontAttributes="Bold" 
                            FontSize="16" 
                            TextColor="{AppThemeBinding Light=#212121, Dark=#e0e0e0}"
                            Margin="0,8,0,0"/>

                      <Label Text="Choose privileges that users with this role will have access to"
                             TextColor="{AppThemeBinding Light=#606060, Dark=#a0a0a0}"
                             FontSize="14"
                             Margin="0,0,0,16"/>

                      <!-- Improved Privileges Groups Section -->
                      <CollectionView ItemsSource="{Binding NewRolePrivilegeGroups}" 
                                      SelectionMode="None">
                        <CollectionView.ItemTemplate>
                          <DataTemplate x:DataType="vm:PrivilegeModuleGroup">
                            <Border Margin="0,0,0,16"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                                    StrokeShape="RoundRectangle 12">
                              <!-- Module Header with modern design -->
                              <Grid RowDefinitions="Auto,*">
                                <Border Grid.Row="0"
                                        BackgroundColor="{AppThemeBinding Light=#e3f2fd, Dark=#263238}"
                                        StrokeThickness="0"
                                        StrokeShape="RoundRectangle 12,12,0,0">
                                  <Grid ColumnDefinitions="Auto,*,Auto" Padding="16,12">
                                    <CheckBox Grid.Column="0" 
                                              IsChecked="{Binding AreAllPrivilegesSelected}"
                                              IsVisible="{Binding HasHeaderCheckbox}"
                                              Color="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                              VerticalOptions="Center">
                                      <CheckBox.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=ToggleModuleGroupSelectionCommand}" 
                                                              CommandParameter="{Binding .}" />
                                      </CheckBox.GestureRecognizers>
                                    </CheckBox>
                                    
                                    <Label Grid.Column="1" 
                                           Text="{Binding ModuleName}" 
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                                           VerticalOptions="Center"
                                           Margin="5,0,0,0" />
                                    
                                    <!-- Enhanced Expand/Collapse Button -->
                                    <Button Grid.Column="2"
                                           Text="{x:Static helpers:MaterialIcons.Arrow_Forward}"
                                           FontFamily="MaterialIcons"
                                           BackgroundColor="Transparent"
                                           TextColor="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                           FontSize="24"
                                           Padding="4"
                                           VerticalOptions="Center"
                                           BorderWidth="0"/>
                                  </Grid>
                                </Border>
                              
                                <!-- Module Privileges with improved styling -->
                                <Border Grid.Row="1"
                                        BackgroundColor="{AppThemeBinding Light=White, Dark=#303030}"
                                        StrokeThickness="0"
                                        StrokeShape="RoundRectangle 12,12}">
                                    <CollectionView ItemsSource="{Binding Privileges}" 
                                                  SelectionMode="None"
                                                  ItemsLayout="VerticalList"
                                                  Margin="0,8">
                                      <CollectionView.Header>
                                        <BoxView HeightRequest="4"/>
                                      </CollectionView.Header>
                                      <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="vm:AccessPrivilegeViewModel">
                                          <Grid Padding="16,12" 
                                              ColumnDefinitions="Auto,*">
                                            <CheckBox Grid.Column="0"
                                                    IsChecked="{Binding IsAssigned}"
                                                    IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=SelectedRole.IsProtected, Converter={StaticResource InvertedBoolConverter}}"
                                                    Color="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                                    VerticalOptions="Start">
                                              <CheckBox.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=TogglePrivilegeCommand}"
                                                                    CommandParameter="{Binding .}"/>
                                              </CheckBox.GestureRecognizers>
                                            </CheckBox>

                                            <VerticalStackLayout Grid.Column="1"
                                                               Margin="0,2,0,0"
                                                               Spacing="4">
                                              <Label Text="{Binding AccessPrivilege.Name}"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#212121, Dark=#EEEEEE}"/>
                                              <Label Text="{Binding AccessPrivilege.Description}"
                                                   TextColor="{AppThemeBinding Light=#757575, Dark=#BBBBBB}"
                                                   FontSize="13"/>
                                            </VerticalStackLayout>
                                          </Grid>
                                        </DataTemplate>
                                      </CollectionView.ItemTemplate>
                                      <CollectionView.Footer>
                                        <BoxView HeightRequest="4"/>
                                      </CollectionView.Footer>
                                    </CollectionView>
                                </Border>
                              </Grid>
                            </Border>
                          </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                          <VerticalStackLayout HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               Spacing="16"
                                               Margin="0,32">
                            <Label Text="{x:Static helpers:MaterialIcons.NotAvailable}"
                                   FontFamily="MaterialIcons"
                                   TextColor="{AppThemeBinding Light=#9E9E9E, Dark=#707070}"
                                   FontSize="36"
                                   HorizontalOptions="Center"/>
                            <Label Text="No privileges available to select"
                                   FontSize="16"
                                   TextColor="{AppThemeBinding Light=#757575, Dark=#909090}"
                                   HorizontalOptions="Center"/>
                          </VerticalStackLayout>
                        </CollectionView.EmptyView>
                      </CollectionView>
                    </VerticalStackLayout>
                  </ScrollView>

                  <!-- Enhanced Action Button -->
                  <Border Grid.Row="2" 
                        Padding="20,16" 
                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#252525}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 0,0,16,16">
                    <Button Text="Create Role"
                            Command="{Binding CreateRoleCommand}"
                            Style="{StaticResource ModernActionButton}"
                            BackgroundColor="#4CAF50"
                            HorizontalOptions="Start">
                      <Button.Shadow>
                        <Shadow Brush="#404CAF50" 
                                Offset="0,3" 
                                Radius="8"/>
                      </Button.Shadow>
                    </Button>
                  </Border>
                </Grid>
              </Frame>
            </ScrollView>

            <!-- Manage Roles Tab -->
            <Grid IsVisible="{Binding IsManageRolesTab}"
                RowDefinitions="*,Auto"
                ColumnDefinitions="2*,5*"
                RowSpacing="16"
                ColumnSpacing="16">
              <!-- Left Side: Roles list -->
              <Frame Style="{StaticResource ModernCardStyle}"
                    Grid.Row="0"
                    Grid.Column="0">
                <Grid RowDefinitions="Auto,*">
                  <!-- Card Header with gradient -->
                  <Border Grid.Row="0"
                          StrokeThickness="0"
                          StrokeShape="RoundRectangle 16,16,0,0">
                    <Border.Background>
                      <LinearGradientBrush StartPoint="0,0"
                          EndPoint="1,1">
                        <GradientStop Color="{AppThemeBinding Light=#673AB7, Dark=#512DA8}"
                            Offset="0.0"/>
                        <GradientStop Color="{AppThemeBinding Light=#7e57c2, Dark=#5e35b1}"
                            Offset="1.0"/>
                      </LinearGradientBrush>
                    </Border.Background>

                    <Grid Padding="20,16">
                      <HorizontalStackLayout Spacing="12">
                        <Label Text="{x:Static helpers:MaterialIcons.Group}"
                               FontFamily="MaterialIcons"
                               TextColor="White"
                               FontSize="24"
                               VerticalOptions="Center"/>
                        <Label Text="Available Roles"
                               FontAttributes="Bold"
                               FontSize="20"
                               TextColor="White"
                               VerticalOptions="Center"/>
                      </HorizontalStackLayout>
                    </Grid>
                  </Border>

                  <!-- Roles List (simplified) -->
                  <Grid Grid.Row="1"
                        RowDefinitions="Auto,*"
                        Padding="20">
                    <!-- List content here -->
                    <Label Grid.Row="0"
                           Text="Select a role to edit"
                           HorizontalOptions="Start"
                           FontSize="14"
                           Margin="12"
                           TextColor="{AppThemeBinding Light=#707070, Dark=#a0a0a0}"/>

                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding Roles}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedRole}">
                      <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Role">
                          <Grid Padding="8,12">
                            <Border StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#333333}">
                              <Border.Triggers>
                                <DataTrigger TargetType="Border"
                                             Binding="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=SelectedItem}"
                                             Value="{Binding .}">
                                  <Setter Property="BackgroundColor"
                                      Value="{AppThemeBinding Light=#e3f2fd, Dark=#1a237e}"/>
                                  <Setter Property="Stroke"
                                      Value="{AppThemeBinding Light=#2196F3, Dark=#3949ab}"/>
                                </DataTrigger>
                              </Border.Triggers>

                              <Grid RowDefinitions="Auto,Auto"
                                  Padding="16,12">
                                <!-- Role Name and Indicator -->
                                <Grid ColumnDefinitions="*,Auto"
                                    Margin="0,0,0,8">
                                  <Label Grid.Column="0"
                                         Text="{Binding RoleName}"
                                         FontSize="16"
                                         FontAttributes="Bold"
                                         TextColor="{AppThemeBinding Light=#212121, Dark=#f5f5f5}"
                                         VerticalOptions="Center"/>

                                  <Border Grid.Column="1"
                                          BackgroundColor="{AppThemeBinding Light=#e8f5e9, Dark=#1b5e20}"
                                          WidthRequest="32"
                                          HeightRequest="32"
                                          StrokeShape="RoundRectangle 16"
                                          HorizontalOptions="End"
                                          IsVisible="{Binding IsProtected}">
                                    <Label Text="{x:Static helpers:MaterialIcons.Lock}"
                                           FontFamily="MaterialIcons"
                                           TextColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                                           FontSize="18"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                  </Border>
                                </Grid>

                                <!-- Role Description -->
                                <Label Grid.Row="1"
                                       Text="{Binding Description}"
                                       FontSize="14"
                                       MaxLines="2"
                                       LineBreakMode="TailTruncation"
                                       TextColor="{AppThemeBinding Light=#757575, Dark=#b0b0b0}"/>

                                <VisualStateManager.VisualStateGroups>
                                  <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Selected">
                                      <VisualState.Setters>
                                        <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light=#e3f2fd, Dark=#1a237e}"/>
                                      </VisualState.Setters>
                                    </VisualState>
                                  </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                              </Grid>
                            </Border>

                            <!-- Animation trigger for selection -->
                            <Grid.GestureRecognizers>
                              <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=SelectRoleCommand}"
                                                    CommandParameter="{Binding .}"/>
                            </Grid.GestureRecognizers>
                          </Grid>
                        </DataTemplate>
                      </CollectionView.ItemTemplate>
                      <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Spacing="16"
                                             Margin="0,32">
                          <Label Text="{x:Static helpers:MaterialIcons.NotAvailable}"
                                 FontFamily="MaterialIcons"
                                 TextColor="{AppThemeBinding Light=#9E9E9E, Dark=#707070}"
                                 FontSize="48"
                                 HorizontalOptions="Center"/>
                          <Label Text="No roles available"
                                 FontSize="16"
                                 TextColor="{AppThemeBinding Light=#757575, Dark=#909090}"
                                 HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                      </CollectionView.EmptyView>
                    </CollectionView>
                  </Grid>
                </Grid>
              </Frame>
              
              <!-- Right Side: Role Details with Privileges -->
              <Grid Grid.Column="1"
                   Grid.Row="0"
                   RowDefinitions="Auto,*"
                   IsVisible="{Binding SelectedRole, Converter={StaticResource StringNotNullOrEmptyConverter}}">
                <!-- Role Details Header -->
                <Frame Style="{StaticResource ModernCardStyle}"
                      Grid.Row="0"
                      Margin="0,0,0,16">
                  <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 16,16,0,0">
                      <Border.Background>
                        <LinearGradientBrush StartPoint="0,0"
                            EndPoint="1,1">
                          <GradientStop Color="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                              Offset="0.0"/>
                          <GradientStop Color="{AppThemeBinding Light=#42a5f5, Dark=#1e88e5}"
                              Offset="1.0"/>
                        </LinearGradientBrush>
                      </Border.Background>

                      <Grid Padding="20,16"
                          ColumnDefinitions="*,Auto">
                        <HorizontalStackLayout Grid.Column="0"
                            Spacing="12">
                          <Label Text="{x:Static helpers:MaterialIcons.Edit}"
                                 FontFamily="MaterialIcons"
                                 TextColor="White"
                                 FontSize="24"
                                 VerticalOptions="Center"/>
                          <Label Text="Edit Role"
                                 FontAttributes="Bold"
                                 FontSize="20"
                                 TextColor="White"
                                 VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <!-- Protected Role Indicator -->
                        <HorizontalStackLayout Grid.Column="1"
                                               IsVisible="{Binding SelectedRole.IsProtected}"
                                               BackgroundColor="#60FFFFFF"
                                               Padding="8,4"
                                               Spacing="6"
                                               HorizontalOptions="End"
                                               VerticalOptions="Center">
                          <Label Text="{x:Static helpers:MaterialIcons.Lock}"
                                 FontFamily="MaterialIcons"
                                 TextColor="White"
                                 FontSize="18"
                                 VerticalOptions="Center"/>
                          <Label Text="System Protected"
                                 TextColor="White"
                                 FontSize="14"
                                 FontAttributes="Bold"
                                 VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                      </Grid>
                    </Border>

                    <ScrollView Grid.Row="1">
                      <VerticalStackLayout Padding="24,20"
                          Spacing="16">
                        <!-- Role Name -->
                        <Label Text="Role Name"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#505050, Dark=#b0b0b0}"/>

                        <Border Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 10"
                                BackgroundColor="{AppThemeBinding Light=#f7f7f7, Dark=#333333}"
                                Padding="5,0"
                                Margin="0,4,0,8">
                          <Entry Placeholder="Enter role name"
                                 Text="{Binding SelectedRole.RoleName}"
                                 BackgroundColor="Transparent"
                                 IsReadOnly="{Binding SelectedRole.IsProtected}"
                                 Margin="10,0"/>
                        </Border>

                        <!-- Role Description -->
                        <Label Text="Description"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#505050, Dark=#b0b0b0}"/>

                        <Border Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 10"
                                BackgroundColor="{AppThemeBinding Light=#f7f7f7, Dark=#333333}"
                                Padding="5,0"
                                Margin="0,4,0,16">
                          <Entry Placeholder="Enter role description"
                                 Text="{Binding SelectedRole.Description}"
                                 BackgroundColor="Transparent"
                                 IsReadOnly="{Binding SelectedRole.IsProtected}"
                                 Margin="10,0"/>
                        </Border>
                      </VerticalStackLayout>
                    </ScrollView>
                  </Grid>
                </Frame>

                <!-- Privileges Content -->
                <Frame Style="{StaticResource ModernCardStyle}"
                        Grid.Row="1">
                  <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 16,16,0,0">
                      <Border.Background>
                        <LinearGradientBrush StartPoint="0,0"
                            EndPoint="1,1">
                          <GradientStop Color="{AppThemeBinding Light=#009688, Dark=#00796B}"
                              Offset="0.0"/>
                          <GradientStop Color="{AppThemeBinding Light=#26A69A, Dark=#00897B}"
                              Offset="1.0"/>
                        </LinearGradientBrush>
                      </Border.Background>

                      <Grid Padding="20,16">
                        <HorizontalStackLayout Spacing="12">
                          <Label Text="{x:Static helpers:MaterialIcons.AdminSettings}"
                                 FontFamily="MaterialIcons"
                                 TextColor="White"
                                 FontSize="24"
                                 VerticalOptions="Center"/>
                          <Label Text="Role Privileges"
                                 FontAttributes="Bold"
                                 FontSize="20"
                                 TextColor="White"
                                 VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                      </Grid>
                    </Border>
                    <ScrollView Grid.Row="1" VerticalScrollBarVisibility="Always">
                      <VerticalStackLayout Padding="20,16"
                                         Spacing="16">
                        <!-- Role Privileges Section Header -->
                        <Label Text="Role Permissions"
                               FontAttributes="Bold"
                               FontSize="18"
                               TextColor="{AppThemeBinding Light=#212121, Dark=#e0e0e0}"/>
                        
                        <Label Text="{Binding RolePrivilegeGroups.Count, StringFormat='Available privilege groups: {0}'}"
                               TextColor="{AppThemeBinding Light=#606060, Dark=#a0a0a0}"
                               FontSize="14"
                               Margin="0,0,0,8"/>
                        
                        <Label Text="{Binding RolePrivileges.Count, StringFormat='Total privileges: {0}'}"
                               TextColor="{AppThemeBinding Light=#606060, Dark=#a0a0a0}"
                               FontSize="14" 
                               Margin="0,0,0,16"/>

                        <!-- Display privileges for the selected role grouped by module -->
                        <CollectionView ItemsSource="{Binding RolePrivilegeGroups}"
                                      BackgroundColor="{AppThemeBinding Light=#F9F9F9, Dark=#202020}"
                                      SelectionMode="None"
                                      HeightRequest="1000"
                                      Margin="0,0,0,20"
                                      VerticalOptions="Start">
                          <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="vm:PrivilegeModuleGroup">
                              <Border Margin="0,0,0,16"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#505050}"
                                    StrokeShape="RoundRectangle 12">
                                <!-- Module Header with modern design -->
                                <Grid RowDefinitions="Auto,*">
                                  <Border Grid.Row="0"
                                        BackgroundColor="{AppThemeBinding Light=#e3f2fd, Dark=#263238}"
                                        StrokeThickness="0"
                                        StrokeShape="RoundRectangle 12,12,0,0">
                                    <Grid ColumnDefinitions="Auto,*,Auto"
                                        Padding="16,12">
                                      <CheckBox Grid.Column="0"
                                              IsChecked="{Binding AreAllPrivilegesSelected}"
                                              IsVisible="{Binding HasHeaderCheckbox}"
                                              Color="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                              IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=SelectedRole.IsProtected, Converter={StaticResource InvertedBoolConverter}}"
                                              VerticalOptions="Center">
                                        <CheckBox.GestureRecognizers>
                                          <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=ToggleRoleModuleGroupSelectionCommand}"
                                                              CommandParameter="{Binding .}"/>
                                        </CheckBox.GestureRecognizers>
                                      </CheckBox>

                                      <Label Grid.Column="1"
                                           Text="{Binding ModuleName}"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                                           VerticalOptions="Center"
                                           Margin="5,0,0,0"/>

                                      <!-- Expand/Collapse Button -->
                                      <Button Grid.Column="2"
                                            Text="{x:Static helpers:MaterialIcons.Arrow_Forward}"
                                            FontFamily="MaterialIcons"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                            FontSize="24"
                                            Padding="4"
                                            VerticalOptions="Center"
                                            BorderWidth="0"/>
                                    </Grid>
                                  </Border>

                                  <!-- Module Privileges with improved styling -->
                                  <Border Grid.Row="1"
                                        BackgroundColor="{AppThemeBinding Light=White, Dark=#303030}"
                                        StrokeThickness="0"
                                        StrokeShape="RoundRectangle 12,12}">
                                    <CollectionView ItemsSource="{Binding Privileges}" 
                                                  SelectionMode="None"
                                                  ItemsLayout="VerticalList"
                                                  Margin="0,8">
                                      <CollectionView.Header>
                                        <BoxView HeightRequest="4"/>
                                      </CollectionView.Header>
                                      <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="vm:AccessPrivilegeViewModel">
                                          <Grid Padding="16,12" 
                                              ColumnDefinitions="Auto,*">
                                            <CheckBox Grid.Column="0"
                                                    IsChecked="{Binding IsAssigned}"
                                                    IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=SelectedRole.IsProtected, Converter={StaticResource InvertedBoolConverter}}"
                                                    Color="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                                    VerticalOptions="Start">
                                              <CheckBox.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RoleManagementViewModel}}, Path=TogglePrivilegeCommand}"
                                                                    CommandParameter="{Binding .}"/>
                                              </CheckBox.GestureRecognizers>
                                            </CheckBox>

                                            <VerticalStackLayout Grid.Column="1"
                                                               Margin="0,2,0,0"
                                                               Spacing="4">
                                              <Label Text="{Binding AccessPrivilege.Name}"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#212121, Dark=#EEEEEE}"/>
                                              <Label Text="{Binding AccessPrivilege.Description}"
                                                   TextColor="{AppThemeBinding Light=#757575, Dark=#BBBBBB}"
                                                   FontSize="13"/>
                                            </VerticalStackLayout>
                                          </Grid>
                                        </DataTemplate>
                                      </CollectionView.ItemTemplate>
                                      <CollectionView.Footer>
                                        <BoxView HeightRequest="4"/>
                                      </CollectionView.Footer>
                                    </CollectionView>
                                  </Border>
                                </Grid>
                              </Border>
                            </DataTemplate>
                          </CollectionView.ItemTemplate>
                          <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               Spacing="16"
                                               Margin="0,32">
                              <Label Text="{x:Static helpers:MaterialIcons.NotAvailable}"
                                   FontFamily="MaterialIcons"
                                   TextColor="{AppThemeBinding Light=#9E9E9E, Dark=#707070}"
                                   FontSize="36"
                                   HorizontalOptions="Center"/>
                              <Label Text="No privileges available for this role"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#757575, Dark=#909090}"
                                   HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                          </CollectionView.EmptyView>
                        </CollectionView>
                      </VerticalStackLayout>
                    </ScrollView>
                  </Grid>
                </Frame>
              </Grid>

              <!-- No Role Selected Message -->
              <ContentView Grid.Column="1"
                  Grid.Row="0"
                  IsVisible="{Binding SelectedRole, Converter={StaticResource NullToBoolConverter}}">
                <Border BackgroundColor="{AppThemeBinding Light=White, Dark=#2d2d2d}"
                        Shadow="{Shadow Brush={AppThemeBinding Light=#40000000, Dark=#40000000}, Offset='0,4', Radius=12}"
                        StrokeThickness="1"
                        Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#3e3e3e}"
                        HorizontalOptions="Fill"
                        VerticalOptions="Fill">
                  <VerticalStackLayout HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       Spacing="16">
                    <Label Text="{x:Static helpers:MaterialIcons.Info}"
                        FontFamily="MaterialIcons"
                        FontSize="48"
                        TextColor="{AppThemeBinding Light=#9E9E9E, Dark=#707070}"
                        HorizontalOptions="Center"/>
                    <Label Text="Select a Role"
                        FontSize="22"
                        FontAttributes="Bold"
                        TextColor="{AppThemeBinding Light=#424242, Dark=#E0E0E0}"
                        HorizontalOptions="Center"/>
                    <Label Text="Choose a role from the list to view and edit its details"
                        FontSize="16"
                        TextColor="{AppThemeBinding Light=#757575, Dark=#BBBBBB}"
                        HorizontalOptions="Center"
                        HorizontalTextAlignment="Center"
                        MaximumWidthRequest="280"/>
                  </VerticalStackLayout>
                </Border>
              </ContentView>

              <!-- Action Buttons at the bottom -->
              <Grid Grid.Row="1"
                  Grid.Column="1"
                    Padding="20,16"
                    BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#252525}"
                    ColumnDefinitions="*,Auto,Auto"
                    ColumnSpacing="12"
                    Margin="0,0,0,16"
                    IsVisible="{Binding SelectedRole, Converter={StaticResource StringNotNullOrEmptyConverter}}">
                <!-- Delete Role Button -->
                <Button Grid.Column="0"
                        Text="Delete Role"
                        Command="{Binding DeleteRoleCommand}"
                        Style="{StaticResource OutlinedButton}"
                        BackgroundColor="Transparent"
                        BorderColor="{AppThemeBinding Light=#f44336, Dark=#ef5350}"
                        TextColor="{AppThemeBinding Light=#f44336, Dark=#ef5350}"
                        IsEnabled="{Binding SelectedRole.IsProtected, Converter={StaticResource InvertedBoolConverter}}"
                        HorizontalOptions="Start"/>

                <!-- Cancel Button (resets selections without saving) -->
                <Button Grid.Column="1"
                        Text="Cancel"
                        Command="{Binding InitializeDataCommand}"
                        Style="{StaticResource OutlinedButton}"
                        BackgroundColor="Transparent"
                        BorderColor="{AppThemeBinding Light=#9e9e9e, Dark=#757575}"
                        TextColor="{AppThemeBinding Light=#9e9e9e, Dark=#757575}"
                        HorizontalOptions="End"/>

                <!-- Save Role Button -->
                <Button Grid.Column="2"
                        Text="Save Changes"
                        Command="{Binding SaveRoleCommand}"
                        Style="{StaticResource ModernActionButton}"
                        BackgroundColor="#4CAF50"
                        IsEnabled="{Binding SelectedRole.IsProtected, Converter={StaticResource InvertedBoolConverter}}"
                        HorizontalOptions="End">
                  <Button.Shadow>
                    <Shadow Brush="#404CAF50"
                            Offset="0,3"
                            Radius="8"/>
                  </Button.Shadow>
                </Button>
              </Grid>
            </Grid>
          </Grid>
        </Grid>
      </VerticalStackLayout>
    </ScrollView>

    <!-- Loading Overlay stays at root -->
    <controls:LoadingOverlay IsVisible="{Binding IsBusy}"
        LoadingText="{Binding Title}"
        ActivityIndicatorColor="{AppThemeBinding Light=#3f51b5,Dark=#7986CB}"
        TextColor="{AppThemeBinding Light=#3f51b5,Dark=#7986CB}"/>
  </Grid>
</views:ViewBase>